<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="">
	<title>Messenger with Authentication</title>

	<!-- Bootstrap core CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
		crossorigin="anonymous">

	<style>
		body {
			background: url("images/messenger-bg.png"), url("images/auth-bg.png");
			background-position: right top, left top;
			background-repeat: no-repeat;
			overflow-x: hidden;
		}

		main {
			margin: 0 auto;
		}

		.form-control:disabled {
			background-color: #fff;
			color: #5f6368;
		}

		.formLabel {
			-webkit-transform: scale(0.75) translateY(29px);
			transform: scale(0.75) translateY(29px);
			background: #fff;
			bottom: 17px;
			-webkit-box-sizing: border-box;
			box-sizing: border-box;
			color: #5f6368;
			font-size: 18px;
			font-weight: 400;
			left: 8px;
			max-width: -webkit-calc(100% - (2*8px));
			max-width: calc(100% - (2*8px));
			overflow: hidden;
			padding: 0 8px;
			text-overflow: ellipsis;
			-webkit-transition: transform 150ms cubic-bezier(0.4, 0, 0.2, 1), opacity 150ms cubic-bezier(0.4, 0, 0.2, 1);
			transition: transform 150ms cubic-bezier(0.4, 0, 0.2, 1), opacity 150ms cubic-bezier(0.4, 0, 0.2, 1);
			white-space: nowrap;
			width: auto;
			z-index: 1;
		}

		.formCheckLabel {
			background: #fff;
			bottom: 17px;
			left: 8px;
			padding: 0 8px;
			text-overflow: ellipsis;
		}

		.bd-placeholder-img {
			font-size: 1.125rem;
			text-anchor: middle;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}

		@media (min-width: 768px) {
			.bd-placeholder-img-lg {
				font-size: 3.5rem;
			}
		}
	</style>
</head>

<body>
	
	<main>

		<!-- Main jumbotron for a primary marketing message or call to action -->
		<!-- <div class="jumbotron text-center"> -->
		<div class="container-fluid">
			<div class="row text-center">
				<div class="col-sm-12 mt-2">
					<h2>Messenger with Authentication</h2>
					<p>Enables the new sign in experience with OKTA Identity provider</p>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-4"></div>
				<div class="col-sm-4">
					<div class="card mb-4 shadow-sm">
						<div class="card-header text-center">
							Enter your deployment details
						</div>
						<div class="card-body pt-0">
							<label class="formLabel" for="read_deploymentId">Deployment ID (Read only)</label>
							<input type="text" id="read_deploymentId" class="form-control" required autofocus disabled>
							<label class="formLabel" for="read_environment">Environment (Read only)</label>
							<select class="form-control" id="read_environment" disabled>
								<option value="apne1">Prod APNE1</option>
								<option value="apne2">Prod APNE2</option>
								<option value="apse2">Prod APSE2</option>
								<option value="aps1">Prod APS1</option>
								<option value="cac1">Prod CAC1</option>
								<option value="euc1">Prod EUC1</option>
								<option value="euw1">Prod EUW1</option>
								<option value="euw2">Prod EUW2</option>
								<option value="use1" selected>Prod USE1</option>
								<option value="usw2">Prod USW2</option>
								<option value="fedramp-use2">Prod FEDRAMP-USE2</option>
								<option value="maximus-use2">Prod MAXIMUS-USE2</option>
							</select>
							<label class="formLabel" for="docCategory">Choose Category</label>
							<select class="form-control" id="docCategory">
								<option value="All" selected>All</option>
								<option value="Transcript">Transcript</option>
								<option value="G Data">G Data</option>
								<option value="G Reports">G Reports</option>
								<option value="G Switch All">G Switch All</option>
								<option value="G Switch From">G Switch From</option>
								<option value="G Switch To">G Switch To</option>
								<option value="Curated G Switch All">Curated G Switch All</option>
								<option value="Curated G Switch Smart">Curated G Switch Smart</option>
								<option value="Curated G Switch From">Curated G Switch From</option>
								<option value="Curated G Switch To">Curated G Switch To</option>
								<option value="Company Research">Company Research</option>
							</select>
							<label class="formLabel" for="langCode">Choose Language</label>
							<select class="form-control" id="langCode">
								<option value="en-us" selected>English</option>
								<option value="fr-fr">French</option>
								<option value="it-it">Italian</option>
								<option value="es-es">Spanish</option>
								<option value="pt-pt">Portuguese</option>
								<option value="de-de">German</option>
							</select>
							<label for="nbResults" class="formLabel">Nb Results</label>
							<input type="number" id="nbResults" class="form-control" value="20">
							<div class="form-check">
								<input class="form-check-input form-control" type="checkbox" value="" id="provideRef">
								<label class="form-check-label formCheckLabel" for="provideRef">
									Provide References
								</label>
							</div>
							<div class="form-check">
								<input class="form-check-input form-control" type="checkbox" value="" id="smartFilter">
								<label class="form-check-label formCheckLabel" for="smartFilter">
									Use "Smart" filter
								</label>
							</div>
							<div class="form-check">
								<input class="form-check-input form-control" type="checkbox" value="" id="queryDecomp">
								<label class="form-check-label formCheckLabel" for="queryDecomp">
									Query Decomposition
								</label>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row justify-content-md-center mb-1">
				<div class="col-md-3" id="okta_sign_in">
					<div class="card text-center justify-content-md-center">
						<div class="card-header">
							<button class="btn btn-md btn-primary btn-block text-center" id="authLoginBtn">Sign In with OKTA</button>
						</div>
					</div>
				</div>

				<div class="col-md-3" id="okta_sign_out" style="display: none;">
					<div class="card text-center justify-content-md-center">
						<div class="card-header">
							<button class="btn btn-md btn-primary btn-block text-center" id="authLogoutBtn">Sign Out</button>
						</div>
					</div>
				</div>

				<div class="col-md-3" id="loading" style="display: none;">
					<div class="card text-center justify-content-md-center">
						<div class="card-header">
							<button class="btn btn-md btn-primary btn-block text-center">Signing In...</button>
						</div>
					</div>
				</div>
			</div>
		</div>

	</main>

	<script src="https://global.oktacdn.com/okta-auth-js/7.14.1/okta-auth-js.min.js" type="text/javascript"></script>

	<script type="text/javascript">

		// defaults
		let queryParams = new URLSearchParams(window.location.search);
    	let depId = queryParams.get('depId');
		if (depId) {
			window.localStorage.setItem('genesys_deployment_id', depId);
		}
		let env = queryParams.get('env');
		if (env) {
			window.localStorage.setItem('genesys_environment', env.toLowerCase());
		}
		let okta_clientId = queryParams.get('clientId');
		if (okta_clientId) {
			window.localStorage.setItem('clientId', okta_clientId);
		}
		let okta_domain = queryParams.get('odomain');
		if (okta_domain) {
			let okta_url = 'https://' + okta_domain + '.okta.com/oauth2/default';
			window.localStorage.setItem('oktaurl', okta_url);
		}

		var sDeploymentId = '';
		var sEnvironment = '';

		if (window.localStorage.getItem('genesys_deployment_id')) {
			document.getElementById('read_deploymentId').value = window.localStorage.getItem('genesys_deployment_id');
		} else {
			document.getElementById('read_deploymentId').value = sDeploymentId;
		}

		if (window.localStorage.getItem('genesys_environment')) {
			document.getElementById('read_environment').value = window.localStorage.getItem('genesys_environment');
		} else {
			document.getElementById('read_environment').value = sEnvironment;
		}

		if (window.localStorage.getItem('genesys_docCategory')) {
			document.getElementById('docCategory').value = window.localStorage.getItem('genesys_docCategory');
		}
		if (window.localStorage.getItem('genesys_langCode')) {
			document.getElementById('langCode').value = window.localStorage.getItem('genesys_langCode');
		}
		if (window.localStorage.getItem('genesys_nbResults')) {
			document.getElementById('nbResults').value = window.localStorage.getItem('genesys_nbResults');
		}
		if (window.localStorage.getItem('genesys_provideRef')) {
			document.getElementById('provideRef').checked = window.localStorage.getItem('genesys_provideRef').toLowerCase() === 'true' ? true : false;
		}
		if (window.localStorage.getItem('genesys_smartFilter')) {
			document.getElementById('smartFilter').checked = window.localStorage.getItem('genesys_smartFilter').toLowerCase() === 'true' ? true : false;
		}
		if (window.localStorage.getItem('genesys_queryDecomp')) {
			document.getElementById('queryDecomp').checked = window.localStorage.getItem('genesys_queryDecomp').toLowerCase() === 'true' ? true : false;
		}

		function updateMessengerLocaleAndAttributes() {
			const docCategory = document.getElementById("docCategory").value;
			window.localStorage.setItem('genesys_docCategory', docCategory);
			const langCode = document.getElementById("langCode").value;
			window.localStorage.setItem('genesys_langCode', langCode);
			const provideRef = document.getElementById("provideRef").checked;
			window.localStorage.setItem('genesys_provideRef', provideRef.toString());
			const smartFilter = document.getElementById("smartFilter").checked;
			window.localStorage.setItem('genesys_smartFilter', smartFilter.toString());
			const queryDecomp = document.getElementById("queryDecomp").checked;
			window.localStorage.setItem('genesys_queryDecomp', queryDecomp.toString());
			const nbResults = document.getElementById("nbResults").value;
			window.localStorage.setItem('genesys_nbResults', nbResults);

			console.log("Current Values:");
			console.log("Category:", docCategory);
			console.log("Language:", langCode);
			console.log("Provide References:", provideRef);
			console.log("Smart Filter:", smartFilter);
			console.log("Query Decomposition:", queryDecomp);
			console.log("Nb Results:", nbResults);

			if (Genesys) {
				Genesys("command", "Messenger.configure", { config: { lang: langCode } }, function () {
					console.log("Messenger language updated!");
				}, function (e) {
					console.error("Error calling Messenger.configure", e);
				});

				Genesys("command", "Database.set",
					{ messaging: { customAttributes: { docCategory: docCategory, langCode: langCode, provideRef: provideRef.toString(), smartFilter: smartFilter.toString(), queryDecomp: queryDecomp.toString(), nbResults: nbResults } } },
					function (data) { /* fulfilled, returns data */ },
					function () { /* rejected */ }
				);
			}
		}

		document.getElementById("docCategory").addEventListener("change", updateMessengerLocaleAndAttributes);
		document.getElementById("langCode").addEventListener("change", updateMessengerLocaleAndAttributes);
		document.getElementById("provideRef").addEventListener("change", updateMessengerLocaleAndAttributes);
		document.getElementById("smartFilter").addEventListener("change", updateMessengerLocaleAndAttributes);
		document.getElementById("queryDecomp").addEventListener("change", updateMessengerLocaleAndAttributes);
		document.getElementById("nbResults").addEventListener("change", updateMessengerLocaleAndAttributes);

		var DOMAINS = {
			'apne1': 'mypurecloud.jp',
			'apne2': 'apne2.pure.cloud',
			'apse2': 'mypurecloud.com.au',
			'aps1': 'aps1.pure.cloud',
			'cac1': 'cac1.pure.cloud',
			'euc1': 'mypurecloud.de',
			'euw1': 'mypurecloud.ie',
			'euw2': 'euw2.pure.cloud',
			'use1': 'mypurecloud.com',
			'usw2': 'usw2.pure.cloud',
			'fedramp-use2': 'use2.us-gov-pure.cloud',
			'maximus-use2': 'use2.maximus-pure.cloud',
		};

		var sGenesysJSDomain = "https://apps." + DOMAINS[window.localStorage.getItem('genesys_environment')];

	</script>

	<script type="text/javascript">
		(function (g, e, n, es, ys) {
			g['_genesysJs'] = e; g[e] = g[e] || function () { (g[e].q = g[e].q || []).push(arguments) };
			g[e].t = 1 * new Date(); g[e].c = es;
			ys = document.createElement('script'); ys.async = 1; ys.src = n; ys.charset = 'utf-8'; document.head.appendChild(ys);
		})(window, 'Genesys', sGenesysJSDomain + '/genesys-bootstrap/genesys.min.js', {
			environment: window.localStorage.getItem('genesys_environment'),
			deploymentId: window.localStorage.getItem('genesys_deployment_id'),
			debug: true
		});
	</script>

	<script>

		if (Genesys) {

			Genesys("subscribe", "Launcher.ready" , function(o){
				console.log("Launcher Ready");
				updateMessengerLocaleAndAttributes();
			});

			Genesys("subscribe", "Messenger.opened" , function(o){
				console.log("Messenger Opened");
				updateMessengerLocaleAndAttributes();
			});

			const ndAuthLoginBtn = document.getElementById('authLoginBtn');
			const ndAuthLogoutBtn = document.getElementById('authLogoutBtn');
			const ndLoading = document.getElementById('loading');
			// const ndSignInButton = document.getElementById('signInButton');
			// const ndSignContent = document.getElementById('signin');
			const bFetching = localStorage.getItem('authFetching'); // eslint-disable-line
			// let sRedirectURL = window.location.href;
			let sRedirectURL = window.location.protocol + '//' + window.location.host + window.location.pathname; /**OKTA redirecturi is expected to be the full path in case of the deployed url */
			window.location.pathname
			let bAuthenticated = false,
				bAlreadyAuthorized = false,
				authClient = '',
				brandAuthCode = '';

			// LocalStorage usage is must for this product
			// If their exists any previous selections, grab and add them
			const clientId = window.localStorage.getItem('clientId'); // eslint-disable-line
			const oktaurl = window.localStorage.getItem('oktaurl'); // eslint-disable-line
			const authScope = 'offline_access'; // eslint-disable-line
			// authorization_code_flow, pkce_flow
			const AuthFlow = 'pkce_flow'; // eslint-disable-line
			let maxAge = '1200'; // eslint-disable-line


			/** OktaAuth generates nonce by default and send it to authorization server which then stores it in session storage. In order to send the same nonce to the authClient get it from the session storage and resolve it in getAuthCode
			 * When pkce option is true, OKTAAuth generates its own code verifier and code challenge and stores it in session storage. In order to send the same codeVerifier to the authClient get it from the session storage and resolve it in getAuthCode*/
			let sOktaTransactionStorage = window.sessionStorage.getItem("okta-transaction-storage"), // eslint-disable-line
				verifier = '',
				sNonce = ''; // eslint-disable-line

			if (sOktaTransactionStorage) {
				const oStorage = JSON.parse(sOktaTransactionStorage);

				if (oStorage && Object.keys(oStorage).length) {
					const { codeVerifier, nonce } = oStorage || {};

					verifier = codeVerifier || '';
					sNonce = nonce || '';
				}
			}

			const QueryString = window.location.search;
			const urlParams = new URLSearchParams(QueryString);

			if (urlParams.has('code')) {
				brandAuthCode = urlParams.get('code');
			} else {
				const query = window.location.search.substring(1);
				const code = query.split('code=')[1];

				brandAuthCode = code && code.split('&')[0];
			}

			if (sRedirectURL && sRedirectURL.indexOf('?code') !== -1) { /**split the redirect url from the authorized okta response and pass it to the getAuthcode command */
				bAlreadyAuthorized = true;
				const aPath = sRedirectURL.split('?code');

				sRedirectURL = aPath && aPath.length && aPath[0];
			}

			if(oktaurl && sRedirectURL){ /**Initialize the okta auth client with the config options */
				authClient = new OktaAuth({
					issuer: `${oktaurl}`,
					redirectUri: `${sRedirectURL}`,
					postLogoutRedirectUri: `${sRedirectURL}`
				});
			}

			let bPKCE = AuthFlow == "pkce_flow" || false;

			Genesys('subscribe', 'GenesysJS.configurationReceived', function (config) {
				if (config) {
					const { deploymentConfig } = config.data || {};
					const { auth } = deploymentConfig || {};
					const { enabled: bAuthEnabled } = auth || {};
					if (bAuthEnabled) {
						// ndSignInButton && ndSignInButton.removeAttribute("disabled");
						// if (!bAuthenticated && !bAlreadyAuthorized && ndSignInButton.classList.contains("collapsed")) {
						// 	ndSignInButton.classList.remove("collapsed");
						// 	ndSignContent.classList.remove("collapse");
						// 	ndSignContent.classList.add("show");
						// }
					}
				}
			});

			function toggleLogin() {
				if (bAuthenticated) {
					document.getElementById("okta_sign_in").style.display = 'none';
					document.getElementById("okta_sign_out").style.display = 'block';
					ndLoading.style.display = 'none';
				} else {
					if (bFetching && bFetching == 'false') {
						document.getElementById("okta_sign_in").style.display = 'block';
					}
					document.getElementById("okta_sign_out").style.display = 'none';
				}
			}

			function showProgress() {
				document.getElementById("okta_sign_in").style.display = 'none';
				document.getElementById("okta_sign_out").style.display = 'none';
				ndLoading.style.display = 'block';
			}

			function hideProgress() {
				ndLoading.style.display = 'none';
			}

			function brandLogin() { // eslint-disable-line

				const sClientId = window.localStorage.getItem('clientId');
				const sOktaurl = window.localStorage.getItem('oktaurl');
				const sAuthScope = 'offline_access';
				// authorization_code_flow, pkce_flow
				const sAuthFlow = 'pkce_flow';
				maxAge = '1200';

				bPKCE = sAuthFlow == "pkce_flow" || false;

				const aScopes = ['openid', 'email', 'profile'];

				if (sClientId && sOktaurl) { // eslint-disable-line
					showProgress();
					// LocalStorage usage is must for this product
					localStorage.setItem('authFetching', true); // eslint-disable-line
					if (sAuthScope === 'offline_access') aScopes.push(sAuthScope);// eslint-disable-line

					const oktaConfig = {// eslint-disable-line
						redirectUri: `${sRedirectURL}`,
						clientId: sClientId,
						issuer: `${sOktaurl}`,
						scopes: aScopes,
						pkce: bPKCE ? true : false,
						responseType: 'code',
					};

					if (maxAge) {
						oktaConfig.maxAge = parseInt(maxAge) // eslint-disable-line
					}

					/**Initialize the okta auth client with the config options */

					if (!authClient) authClient = new OktaAuth(oktaConfig); // eslint-disable-line 

					authClient.signInWithRedirect({
						originalUri: `${window.location.href}`,
						...oktaConfig,
					});


				} else {
					// LocalStorage usage is must for this product
					localStorage.setItem('authFetching', false);  // eslint-disable-line
				}
			}

			function clearStorage() {
				// LocalStorage usage is must for this product
				localStorage.setItem('authFetching', false);  // eslint-disable-line
			}

			ndAuthLoginBtn.onclick = function () {              // eslint-disable-line
				brandLogin();
			};
			// LocalStorage usage is must for this product

			if (bFetching === 'true') {
				showProgress();
			}
			else {
				toggleLogin();
			}

			// OpenId Authentication setup

			// AuthProvider plugin written by the brand

			Genesys('registerPlugin', 'AuthProvider', (AuthProvider) => {
				// COMMANDS

				// getAuthCode
				// getTokens
				// setTokens

				/* Register Commands */

				AuthProvider.registerCommand('getAuthCode', (e) => {
					const { forceUpdate } = e.data || {};
					if (forceUpdate) {
						ndAuthLoginBtn.click(); // simulate the login click.
						e.resolve();
					} else {
						const sData = {
							authCode: brandAuthCode,
							redirectUri: `${sRedirectURL}`,
							nonce: sNonce,
						};

						if (maxAge) sData.maxAge = parseInt(maxAge);
						if (bPKCE && verifier) sData.codeVerifier = verifier;

						e.resolve(sData);
					}
				});

				AuthProvider.registerCommand('reAuthenticate', (e) => {
					// Brand can handle this how ever they want.
					// This command will be called when current refreshToken and/or authCode are no more valid. User needs to re-login here to provide us new authCode and/or refreshToken.
					ndAuthLoginBtn.click(); // simulate the login click.
					e.resolve();
				});

				AuthProvider.subscribe('Auth.ready', () => {
					bAuthenticated = AuthProvider.data('Auth.authenticated');
					toggleLogin();
				});

				AuthProvider.subscribe('Auth.authenticated', () => {
					bAuthenticated = true;
					hideProgress();
					// LocalStorage usage is must for this product
					localStorage.setItem('authFetching', false);  // eslint-disable-line
					toggleLogin();
				});

				AuthProvider.subscribe('Auth.error', (error) => {
					const { message } = error.data || {};

					hideProgress();
					// 'message' here is provided by our API and its always expected to be in string. Any security scan results are false postive in this case.
					console.log("Auth Error", message);
					// LocalStorage usage is must for this product
					localStorage.setItem('authFetching', false); // eslint-disable-line
				});

				AuthProvider.subscribe('Auth.authError', (error) => {
					hideProgress();
					// 'message' here is provided by our API and its always expected to be in string. Any security scan results are false postive in this case.
					console.log("Auth Error", error);
					// LocalStorage usage is must for this product
					clearStorage();
				});

				/* Handlers */

				ndAuthLogoutBtn.onclick = function () {
					AuthProvider.command('Auth.logout')
						.finally(() => {
							bAuthenticated = false;
							if (authClient) authClient.signOut();
							// bFetching = 'false';
							toggleLogin();
							clearStorage();
						});
				};

				// Tell CXBus your plugin is ready (mandatory)
				AuthProvider.ready();
			});
		}

	</script>

	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
		crossorigin="anonymous"></script>

</html>